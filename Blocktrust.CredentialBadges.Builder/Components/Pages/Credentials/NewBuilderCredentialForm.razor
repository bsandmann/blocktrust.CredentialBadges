@using Blocktrust.CredentialBadges.Builder.Enums
@using Blocktrust.CredentialBadges.Builder.Commands.BuilderCredentials.CreateBuilderCredential
@using Blocktrust.CredentialBadges.Builder.Domain
@using FluentResults
@using MediatR
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@inject IMediator Mediator
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthenticationStateProvider
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@namespace Blocktrust.CredentialBadges.Builder.Components.Pages.Credentials

<div class="flex flex-col min-h-[70vh] space-y-6 ">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">New Credential</h3>

    @if (!isDataLoaded)
    {
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
            <strong class="font-bold">Error!</strong>
            <span class="block sm:inline"> Required data not found. Please ensure you have made a connection.</span>
        </div>
    }
    else
    {
        <div class="flex-grow space-y-6 max-h-[55vh] overflow-y-scroll px-4 ">
            <div class="flex items-center space-x-4 mt-8 ">
                <label class="text-gray-600 font-medium w-24">Label:</label>
                <input type="text" class="border border-gray-300 rounded px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-slate-600" @bind="label" />
            </div>
            
            <div class="text-gray-600 font-medium w-48">Credential Subject:</div>

            <div class="flex items-center space-x-4 mt-4">
                <label class="text-gray-600 font-medium w-24">Achievement Type:</label>
                <input type="text" class="border border-gray-300 rounded px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-slate-600" @bind="achievementType" />
            </div>

            <div class="flex items-center space-x-4 mt-4">
                <label class="text-gray-600 font-medium w-24">Name:</label>
                <input type="text" class="border border-gray-300 rounded px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-slate-600" @bind="name" />
            </div>

            <div class="flex items-center space-x-4 mt-4">
                <label class="text-gray-600 font-medium w-24">Description:</label>
                <textarea class="border border-gray-300 rounded px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-slate-600" @bind="description"></textarea>
            </div>

            <div class="flex items-center space-x-4 mt-4">
                <label class="text-gray-600 font-medium w-24">Criteria:</label>
                <textarea class="border border-gray-300 rounded px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-slate-600" @bind="criteria"></textarea>
            </div>

            <div class="flex items-center space-x-4 mt-4">
                <label class="text-gray-600 font-medium w-24">Image:</label>
                <InputFile class="border border-gray-300 rounded px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-slate-600" OnChange="UploadImage" />
            </div>

            @if (!string.IsNullOrEmpty(imageBase64))
            {
                <div class="relative mt-4">
                    <img src="@($"data:image/png;base64,{imageBase64}")" alt="Uploaded Image" class="w-32 h-auto rounded border border-gray-300" />
                    @if (!string.IsNullOrEmpty(message))
                    {
                        <div class="absolute top-0 left-0 right-0 bottom-0 flex items-center justify-center p-2 bg-red-100 bg-opacity-75 text-red-800 rounded">
                            @message
                        </div>
                    }
                </div>
            }

            @if (!string.IsNullOrEmpty(message) && string.IsNullOrEmpty(imageBase64))
            {
                <div class="mt-4 p-4 rounded @(isSuccess ? "bg-green-100 text-green-800" : "bg-red-100 text-red-800")">
                    @message
                </div>
            }
        </div>

        <div class="flex justify-end mt-auto pt-6">
            <button class="bg-slate-600 text-white px-4 py-2 rounded flex items-center" @onclick="CreateCredential" disabled="@(isProcessing || !isDataLoaded)">
                @if (isProcessing)
                {
                    <span class="material-symbols-outlined animate-spin mr-2">refresh</span>
                    <span>Processing...</span>
                }
                else
                { <span>Create Credential</span>
                }
            </button>
        </div>
    }
</div>

@code {
    private string label = "";
    private string achievementType = "";
    private string name = "";
    private string description = "";
    private string criteria = "";
    private string imageBase64 = "";
    private bool isProcessing = false;
    private string message = "";
    private bool isSuccess = false;
    private bool isDataLoaded = false;

    private string subjectDid;
    private string issuerDid = "issuerDid"; // Left as is for now
    private Guid subjectConnectionId;
    private Guid issuerConnectionId;

    protected override async Task OnInitializedAsync()
    {
        await LoadStoredData();
    }

    private async Task LoadStoredData()
    {
        subjectDid = await JS.InvokeAsync<string>("localStorage.getItem", "did");
        var subjectConnectionIdStr = await JS.InvokeAsync<string>("localStorage.getItem", "acceptConnectionId");
        var issuerConnectionIdStr = await JS.InvokeAsync<string>("localStorage.getItem", "initializeConnectionId");

        isDataLoaded = !string.IsNullOrEmpty(subjectDid) &&
                       !string.IsNullOrEmpty(subjectConnectionIdStr) &&
                       !string.IsNullOrEmpty(issuerConnectionIdStr) &&
                       Guid.TryParse(subjectConnectionIdStr, out subjectConnectionId) &&
                       Guid.TryParse(issuerConnectionIdStr, out issuerConnectionId);

        if (!isDataLoaded)
        {
            message = "Required data not found in local storage. Please complete the necessary setup steps.";
        }
    }

    private async Task UploadImage(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            if (file.ContentType != "image/png" && file.ContentType != "image/jpeg")
            {
                message = "Invalid image type. Please upload a PNG or JPEG image.";
                imageBase64 = "";
                return;
            }

            try
            {
                using var stream = file.OpenReadStream(maxAllowedSize: 1024 * 1024); // 1 MB limit
                var buffer = new byte[file.Size];
                await stream.ReadAsync(buffer, 0, (int)file.Size);
                imageBase64 = Convert.ToBase64String(buffer);
                message = ""; // Clear error message if upload is successful
            }
            catch (Exception ex)
            {
                message = $"Error processing image: {ex.Message}";
                imageBase64 = "";
            }
        }
    }

    private async Task CreateCredential()
    {
        if (!isDataLoaded)
        {
            message = "Cannot create credential. Required data is missing.";
            return;
        }

        isProcessing = true;
        message = "";

        var date = DateTime.UtcNow;

        // Get the user's name from the authentication state
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userId = user.Identity?.Name;

        var credentialSubject = new
        {
            AchievementType = achievementType,
            Name = name,
            Description = description,
            Criteria = criteria,
            Image = imageBase64
        };

        var request = new CreateBuilderCredentialRequest
        {
            Date = date,
            Label = label,
            SubjectDid = subjectDid,
            IssuerDid = issuerDid,
            Status = EBuilderCredentialStatus.Pending,
            IssuerConnectionId = issuerConnectionId,
            SubjectConnectionId = subjectConnectionId,
            CredentialSubject = System.Text.Json.JsonSerializer.Serialize(credentialSubject),
            UserId = userId 
        };

        var result = await Mediator.Send<Result<BuilderCredential>>(request);

        if (result.IsSuccess)
        {
            await OnCredentialCreated.InvokeAsync();
            isSuccess = true;
            message = "Credential created successfully.";
            imageBase64 = "";
        }
        else
        {
            isSuccess = false;
            message = $"Failed to create credential: {result.Errors.First().Message}";
        }

        isProcessing = false;
    }

    [Parameter]
    public EventCallback OnCredentialCreated { get; set; }
}
