@page "/generate-demo-credential"
@using Blocktrust.CredentialBadges.Core.Services.Clipboard
@using MediatR
@using Blocktrust.CredentialBadges.Builder.Commands.AutogenerateCredential.GenerateCredential
@using Blocktrust.CredentialBadges.Core.Services.Images
@using Blocktrust.CredentialBadges.Builder.Common
@using Blocktrust.CredentialBadges.Builder.Commands.Connections.InitializeConnection
@using Blocktrust.CredentialBadges.Builder.Commands.Connections.AcceptConnection
@using Microsoft.Extensions.Options
@inject IMediator Mediator
@inject ILogger<GenerateCredentialHandler> Logger
@inject ClipboardService ClipboardService
@inject ImageBytesToBase64 ImageBytesToBase64
@inject IOptions<AppSettings> AppSettings
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<PageTitle>Blocktrust Credentials Generate Credential</PageTitle>

<div class="min-h-screen bg-gray-100 py-6 flex flex-col justify-center sm:py-12">
    <div class="relative py-3 sm:max-w-xl sm:mx-auto">
        <div class="absolute inset-0 bg-gradient-to-r from-cyan-400 to-light-blue-500 shadow-lg transform -skew-y-6 sm:skew-y-0 sm:-rotate-6 sm:rounded-3xl"></div>
        <div class="relative px-4 py-10 bg-white shadow-lg sm:rounded-3xl sm:p-20">
            <h1 class="text-2xl font-semibold text-center mb-6">Generate Demo Credential</h1>

            <div class="space-y-4">
                <div>
                    <label for="issuingDID" class="block text-sm font-medium text-gray-700">Issuing DID</label>
                    <input id="issuingDID" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 bg-gray-100 text-gray-600" value="@_issuingDID" disabled/>
                </div>

                <div>
                    <label for="connectionId" class="block text-sm font-medium text-gray-700">Connection ID</label>
                    <input id="connectionId" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 bg-gray-100 text-gray-600" value="@_connectionId" disabled/>
                </div>

                <div>
                    <label for="subjectId" class="block text-sm font-medium text-gray-700">Subject DID</label>
                    <input id="subjectId" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 bg-gray-100 text-gray-600" value="@_subjectDID" disabled/>
                </div>

                <div>
                    <label for="imageUpload" class="block text-sm font-medium text-gray-700">Upload Image</label>
                    <InputFile id="imageUpload" OnChange="HandleImageUpload" class="mt-1 block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-violet-50 file:text-violet-700
                        hover:file:bg-violet-100"/>
                </div>

                <div>
                    <label for="validityPeriod" class="block text-sm font-medium text-gray-700">Validity Period</label>
                    <input id="validityPeriod" type="number" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" @bind="@_validityPeriod"/>
                </div>
            </div>

            <div class="mt-8">
                <h2 class="text-lg font-semibold mb-2">Achievement Details:</h2>
                <div class="bg-gray-50 p-4 rounded-md">
                    <p><strong>ID:</strong> urn:uuid:bd6d9316-f7ae-4073-a1e5-2f7f5bd22922</p>
                    <p><strong>Type:</strong> Achievement</p>
                    <p><strong>Achievement Type:</strong> Diploma</p>
                    <p><strong>Name:</strong> Diploma in Decentralized Identity Solutions</p>
                    <p><strong>Description:</strong> This credential is issued by Blocktrust University to recognize the completion of a specialized course in developing decentralized identity solutions.</p>
                    <p><strong>Criteria:</strong> This credential was issued to a student who demonstrated proficiency in developing decentralized identity solutions through activities performed in the course titled <em>Advanced Decentralized Identity Solutions</em> offered by Blocktrust University from <strong>January 15, 2024</strong> to <strong>May 30, 2024</strong>. The criteria for earning this credential include:</p>
                    <ul class="list-disc list-inside ml-4">
                        <li>Completion of all course modules</li>
                        <li>Successful participation in hands-on labs</li>
                        <li>Passing all quizzes and final exams</li>
                        <li>Development of a capstone project showcasing decentralized identity solutions</li>
                    </ul>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(_uploadedImageBase64))
            {
                <div class="mt-4">
                    <p class="text-sm font-medium text-gray-700 mb-2">Uploaded Image:</p>
                    <img src="data:image/png;base64,@_uploadedImageBase64" alt="Uploaded Image" class="max-w-full h-auto rounded-md"/>
                </div>
            }

            <div class="mt-8">
                <button class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" @onclick="HandleGenerateCredential">
                    Generate Credential
                </button>
            </div>

            @if (!string.IsNullOrEmpty(_offerResult))
            {
                <div class="mt-8">
                    <h2 class="text-lg font-semibold mb-2">Credential (Base64):</h2>
                    <div class="bg-gray-100 p-4 rounded-md overflow-x-auto">
                        <pre class="text-xs">@_offerResult</pre>
                    </div>
                    <button class="mt-4 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" @onclick="() => ClipboardService.CopyTextToClipboard(_offerResult)">
                        Copy result
                    </button>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private string _issuingDID;
    private string _connectionId = "Connecting...";
    private string _subjectDID;
    private string _uploadedImageBase64 = "";
    private string _offerResult = "";
    private int _validityPeriod = 15;

    protected override async Task OnInitializedAsync()
    {
        _issuingDID = AppSettings.Value.IssuingDID;
        _subjectDID = AppSettings.Value.SubjectDID;

        await InitializeAndAcceptConnection();
    }

    private async Task InitializeAndAcceptConnection()
    {
        var initResult = await Mediator.Send(new InitializeConnectionRequest());
        if (initResult.IsSuccess)
        {
            _connectionId = initResult.Value.ConnectionId;
            await Task.Delay(20000); // Wait for 20 seconds

            var acceptResult = await Mediator.Send(new AcceptConnectionRequest
            {
                ApiKey = AppSettings.Value.SubjectApiKey,
                InvitationUrl = ExtractBase64FromInvitation(initResult.Value.InvitationUrl)
            });

            if (!acceptResult.IsSuccess)
            {
                Logger.LogError("Error accepting connection: {Error}", acceptResult.Errors.FirstOrDefault()?.Message);
                _connectionId = "Error: Failed to accept connection";
            }
        }
        else
        {
            Logger.LogError("Error initializing connection: {Error}", initResult.Errors.FirstOrDefault()?.Message);
            _connectionId = "Error: Failed to initialize connection";
        }
        StateHasChanged();
    }

    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        Logger.LogInformation("Image upload started");
        var imageFile = e.File;
        var buffer = new byte[imageFile.Size];
        await imageFile.OpenReadStream().ReadAsync(buffer);

        var result = ImageBytesToBase64.Convert(buffer);
        if (result.IsSuccess)
        {
            _uploadedImageBase64 = result.Value;
            Logger.LogInformation("Image upload successful, base64: {Base64}", _uploadedImageBase64);
        }
        else
        {
            Logger.LogError("Image upload and conversion failed: {Error}", result.Errors.FirstOrDefault()?.Message);
        }
    }

    private async Task HandleGenerateCredential()
    {
        _offerResult = "generating...";
        if (!Guid.TryParse(_connectionId, out Guid guid))
        {
            _offerResult = "Error creating offer: Not a valid connection id";
            Logger.LogError("Error creating offer: Not a valid connection id");
            return;
        }

        var generateCredentialRequest = new GenerateCredentialRequest
        {
            Claims = new
            {
                type = new List<string> { "AchievementSubject" },
                achievement = new
                {
                    id = "urn:uuid:bd6d9316-f7ae-4073-a1e5-2f7f5bd22922",
                    type = new List<string> { "Achievement" },
                    achievementType = "Diploma",
                    name = "Diploma in Decentralized Identity Solutions",
                    description = "This credential is issued by Blocktrust University to recognize the completion of a specialized course in developing decentralized identity solutions.",
                    criteria = new
                    {
                        type = "Criteria",
                        narrative = "This credential was issued to a student who demonstrated proficiency in developing decentralized identity solutions through activities performed in the course titled *Advanced Decentralized Identity Solutions* offered by Blocktrust University from **January 15, 2024** to **May 30, 2024**. The criteria for earning this credential include:\n1. Completion of all course modules\n2. Successful participation in hands-on labs\n3. Passing all quizzes and final exams\n4. Development of a capstone project showcasing decentralized identity solutions."
                    },
                    image = new
                    {
                        id = "data:image/png;base64,"+_uploadedImageBase64,
                        type = "Image"
                    }
                }
            },
            CredentialFormat = "JWT",
            IssuingDID = _issuingDID,
            ConnectionId = guid,
            SubjectId = _subjectDID,
            AutomaticIssuance = true,
            ValidityPeriod = _validityPeriod
        };

        var result = await Mediator.Send(generateCredentialRequest);

        if (result.IsSuccess)
        {
            _offerResult = result.Value;
            Logger.LogInformation("Offer created successfully: {Result}", result.Value);
        }
        else
        {
            _offerResult = "Error creating offer";
            Logger.LogError("Error creating offer: {Error}", result.Errors.FirstOrDefault()?.Message);
        }
    }
    
    
    public string ExtractBase64FromInvitation(string invitationUrl)
    {
        const string marker = "_oob=";
        int startIndex = invitationUrl.IndexOf(marker);

        if (startIndex == -1)
        {
            throw new ArgumentException("Invalid invitation URL format: '_oob=' marker not found.");
        }

        startIndex += marker.Length;

        string base64String = invitationUrl.Substring(startIndex);

        return base64String;
    }
}